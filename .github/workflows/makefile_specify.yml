name: Build on Tag (No Makefile Change)

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'        # 匹配 v1.2.3 等

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract tag name
        id: get_tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "Building for tag: $TAG"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build images (as latest)
        run: |
          make workflow-controller-image
          make argocli-image
          docker images

      - name: Retag images with version
        run: |
          # 原始镜像（由 Makefile 构建）
          CONTROLLER_LATEST=quay.io/argoproj/workflow-controller:latest
          ARGOCLI_LATEST=quay.io/argoproj/argocli:latest

          # 新标签
          CONTROLLER_TAGGED=quay.io/argoproj/workflow-controller:${{ env.TAG }}
          ARGOCLI_TAGGED=quay.io/argoproj/argocli:${{ env.TAG }}

          # 打新标签
          docker tag $CONTROLLER_LATEST $CONTROLLER_TAGGED
          docker tag $ARGOCLI_LATEST $ARGOCLI_TAGGED

          # 验证
          docker images | grep argoproj

      - name: Save versioned images to tar
        run: |
          echo "quay.io/argoproj/workflow-controller:${{ env.TAG }}" > image-list.txt
          echo "quay.io/argoproj/argocli:${{ env.TAG }}" >> image-list.txt
          docker save -o workflow-deploy.tar $(cat image-list.txt)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: workflow-deploy-image-${{ env.TAG }}
          path: workflow-deploy.tar
          retention-days: 7
