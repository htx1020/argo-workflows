name: Build with Custom Tag

on:
  # 手动触发，支持输入参数
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag'
        required: true
        default: 'latest'
        type: string
      push_to_registry:
        description: 'Push to Docker registry?'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

  # 保留原有的自动触发条件（可选）
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      IMAGE_TAG: ${{ github.event.inputs.tag || 'latest' }}
      PUSH_TO_REGISTRY: ${{ github.event.inputs.push_to_registry || 'false' }}

    steps:
    - uses: actions/checkout@v4

    - name: Log build parameters
      run: |
        echo "Building with tag: $IMAGE_TAG"
        echo "Push to registry: $PUSH_TO_REGISTRY"
        echo "Event type: ${{ github.event_name }}"
        echo "Triggered by: ${{ github.actor }}"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub (if pushing)
      if: env.PUSH_TO_REGISTRY == 'true'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build workflow-controller image
      run: |
        # 设置环境变量传递tag给make命令
        export IMAGE_TAG="$IMAGE_TAG"
        make workflow-controller-image IMAGE_TAG="$IMAGE_TAG"
        docker images | grep workflow-controller

    - name: Build argocli image
      run: |
        export IMAGE_TAG="$IMAGE_TAG"
        make argocli-image IMAGE_TAG="$IMAGE_TAG"
        docker images | grep argocli

    - name: Tag images with custom tag
      run: |
        # 重新标记镜像
        docker tag quay.io/argoproj/workflow-controller:latest quay.io/argoproj/workflow-controller:$IMAGE_TAG
        docker tag quay.io/argoproj/argocli:latest quay.io/argoproj/argocli:$IMAGE_TAG
        
        # 显示所有相关镜像
        docker images | grep -E "(workflow-controller|argocli)"

    - name: Save Docker image to tar
      run: |
        echo "quay.io/argoproj/workflow-controller:$IMAGE_TAG" > image-list.txt
        echo "quay.io/argoproj/argocli:$IMAGE_TAG" >> image-list.txt
        echo "Saving images with tag: $IMAGE_TAG"
        cat image-list.txt
        docker save -o workflow-deploy-$IMAGE_TAG.tar $(cat image-list.txt)
        ls -lh workflow-deploy-*.tar

    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: workflow-deploy-${{ env.IMAGE_TAG }}
        path: workflow-deploy-${{ env.IMAGE_TAG }}.tar
        retention-days: 7

    - name: Push images to registry (optional)
      if: env.PUSH_TO_REGISTRY == 'true'
      run: |
        echo "Pushing images to registry with tag: $IMAGE_TAG"
        docker push quay.io/argoproj/workflow-controller:$IMAGE_TAG
        docker push quay.io/argoproj/argocli:$IMAGE_TAG

    - name: Generate summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "✅ Build completed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image Tag:** $IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Built Images:**" >> $GITHUB_STEP_SUMMARY
        echo "- quay.io/argoproj/workflow-controller:$IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
        echo "- quay.io/argoproj/argocli:$IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Artifact:** workflow-deploy-$IMAGE_TAG.tar" >> $GITHUB_STEP_SUMMARY
        
        if [ "$PUSH_TO_REGISTRY" = "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** Images pushed to quay.io" >> $GITHUB_STEP_SUMMARY
        fi
